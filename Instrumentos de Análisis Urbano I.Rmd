---
title: "Instrumentos de Análisis Urbano I"
author: "Florencia Kihara,  Victoria Marco y Santiago Soubie"
date: "6/6/2021"
output: html_document
---
# **TRABAJO PRÁCTICO FINAL**

*INTEGRANTES*
  - Florencia Kihara
  - Victoria Marco
  - Santiago Soubie

**Consigna**

*Debido a la pandemia del COVID-19, el Gobierno de la Ciudad Autónoma de Buenos Aires tomó la decisión de reutilizar la capacidad hotelera preexistente para poder mejorar la capacidad de atención sanitaria para la población. Sin embargo, encontrar las ubicaciones óptimas no es una tarea trivial.*

*Por un lado, el presupuesto con el que cuenta el GCBA es limitado. Por otro lado, la zona donde estén estos nuevos centros de atención de pacientes va a depender de distintos factores como la accesibilidad y la densidad poblacional.*

*El objetivo de este trabajo es poder indicar las manzanas de la Ciudad de Buenos Aires de mayor viabilidad para el alquiler de algún inmueble en base a los siguientes criterios:*

*● Costo promedio de alquiler*

*● Métricas de accesibilidad (cercanía con avenidas, cercanía con una estación de subte y cualquier otra variable que les pueda parecer útil, tiempo de viaje, en minutos caminando o en auto, desde distintos puntos de la Ciudad)*

*● Densidad poblacional*

```{r}
library(tidyverse)
library(sf)
library(leaflet)
```

```{r}
calles <- st_read("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/callejero.geojson")
```

```{r}
radiosCensales <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/radioscensales.geojson")
```

```{r}
hospitales <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/hospitales.geojson")
```                      

```{r}
manzanas <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/manzanas.geojson")
```                      

```{r}
properati <- read.csv("https://github.com/SSoubie/MEU-Hackers/blob/main/Datasets/properati2021.RData",
                      encoding = "UTF-8",
                      stringsAsFactors = TRUE)
```

```{r}
str(properati2021)
```

```{r}
radiosCensales <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/radioscensales.geojson")
```

```{r}
hospitales <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/hospitales.geojson")
                       
manzanas <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/manzanas.geojson")

```

```{r}
str(properati2021$currency)
```
```{r}
summary(properati2021$currency)
```
Ahora limpiaremos la base de properati para poder dejar la inforamción que nos es de interés para este TP. 
En primer lugar, extraemos el año de la columna "created_on" para poder filtrar los casos del año 2021. 
En adición, hemos dejado solamente los registros donde hay información precisa (por eso descartamos aquellos que no tenían precio) para la Ciudad de Buenos Aires.
Además, pesificamos los precios al dólar blue ($150) de aquellos registros que estaban en dólares para poder tener la misma unidad para todos. 
Por último, eliminamos las columnas que no serían de utilidad para el análisis que realizaremos. 

```{r}
properati2021 <- properati %>% 
  separate(created_on, c("ano", "mes", "dia"), sep = "-") %>% 
  filter(ano=="2021" & l2=="Capital Federal" & price!="NA" & currency!="") %>% 
  mutate(precio=ifelse(currency=="USD", price*150, price*1)) %>% 
  select(-start_date, -end_date, -mes, -dia, -l4, -l5, -l6, -price, -currency)
```


```{r}
summary(properati2021$operation_type)
```

Ahora, vamos a filtrar la variable "property_type" con el fin de poder obtener el valor del metro cuadrado de propiedades de la zona, con el fin de poder crear luego un índice que nos permita cumplir con el objetivo del TP. En este sentido, no tendremos en consideración los valores para las siguientes propiedades: Lote, Casa de Campo, Cochera, PH, Depóstito y Otro (debido a que no sabemos qué tipo de propiedad es).


```{r}
properati2021 <- filter(properati2021, property_type %in% c("Casa", "Departamento", "Local comercial", "Oficina"))
```

```{r}
summary(properati2021$property_type)
```

Ahora calcularemos el precio del metro cuadrado.

```{r}
summary(properati2021$surface_total)
```
```{r}
summary(properati2021$surface_covered)
```

```{r}
properati2021 <- filter(properati2021, !(surface_covered=="NA" & surface_total=="NA"))
```

```{r}
summary(properati2021$surface_covered)
```
```{r}
summary(properati2021$surface_total)
```

```{r}
properati2021 <- mutate(properati2021, superficie=ifelse(is.na(surface_total), surface_covered, surface_total))
```



```{r}
properati2021 <- mutate(properati2021, metro2=precio/superficie, round(metro2,0))
```


```{r}
str(properati2021)
```
```{r}
summary(properati2021$metro2)
```

```{r}
quiebres <- c(0,0.2,0.4,0.6,0.8,1)
```

```{r}
properati2021 <- mutate(properati2021, catmetro2=cut(metro2,breaks = quantile(metro2,quiebres,na.rm = TRUE, dig.lab = 5),include.lowest = TRUE))
```

```{r}
summary(properati2021$catmetro2)
```

```{r}
properati2021 <- mutate(properati2021, cat2metro2=as.numeric(catmetro2))
```


```{r}
properati2021 <- mutate(properati2021, superficiecat=ifelse(superficie %in% 32:55, "Chico",
                                                     ifelse(superficie %in% 56:75, "Mediano",
                                                     ifelse(superficie %in% 76:150, "Grande", "Muy grande"))))
```

```{r}
ggplot(data = properati2021) +
    geom_boxplot(aes(x=superficiecat, y=metro2), show.legend = FALSE)
```
A partir de este boxplot, podemos ver que en dentro de la categoría de departamentos de pequeña superficie, identificamos valores outlyers en el precio de su metro2 (tomaremos como valores outlyers los precios del metro2 mayores a $50.000).Por lo tanto, eliminaremos dichos casos para evitar que sesguen las medidas de tendencia central

```{r}
properati2021 <- filter(properati2021, metro2<50000)
```

```{r}
summary(properati2021$metro2)
```
```{r}
ggplot(data = properati2021) +
    geom_boxplot(aes(x=superficiecat, y=metro2), show.legend = FALSE)
```
A través de este boxplot se puede observar que continúa habiendo valores outlyers pero su magnitud es menor, por lo tanto, no serán eliminados. 

```{r}
properati2021 <- mutate(properati2021, cat2metro2 = recode(cat2metro2, "1"="Muy bajo", "2"="Bajo", "3"="Medio", "4"="Alto", "5"="Muy alto"))
```

Procederemos a componer mapas que nos permitan visualizar la ubicación de las unidades de la base de datos de Properati, a fin de poder identificar las zonas más significativas para continuar para nuestro análisis.


```{r}
mapaCABA <- read_sf("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/barrios/barrios.geojson")
```


```{r}
cantidadpromxbarrio <- properati2021 %>% 
  group_by(l3) %>% 
  summarise(promedio=mean(metro2)) 
```


```{r}
properatisinNA <- filter(properati2021, !(lon=="NA" & lat=="NA"))
```


```{r}
properatisinNA <- st_as_sf(properatisinNA,coords=c("lon","lat"),crs=4326)
```

```{r}
properatisinNA <- st_transform(properatisinNA,crs = st_crs(mapaCABA))
```


```{r}
properatisinNA <- mutate(properatisinNA, cat2metro2=factor(cat2metro2, levels = c ("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto")))
```



```{r fig.height=15, fig.width=15}
ggplot(data=mapaCABA)+
  geom_sf(data=mapaCABA) +
  geom_sf(data=filter (properatisinNA, l3 != ""), aes(color=cat2metro2), size=3)+
  scale_color_viridis_d() +
  theme_minimal()
```

-------------------------------------------------------------------------------------------------------------------------------------------------------------------


**DISTANCIAS**

*DATASETS*

```{r}
mapaCABA <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/mapaCABA.geojson") 
```

```{r}
radiosCensales <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/radioscensales.geojson")
```

```{r}
manzanas <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/manzanas.geojson")
```

*Sumamos la planta del transporte*

```{r}
calles <- st_read("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/callejero.geojson")
```

```{r}
subte <- st_read("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/estacionsubte.geojson")
```

```{r}
metrobus <- st_read("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/estaciones-de-metrobus.geojson")
```
*Sacamos las paradas que se encuentran fuera de la CABA*

```{r}
metrobus <- filter(metrobus, METROBUS!="Metrobus Norte - Av Maipú (provincia)")
```

*Sumamos las infraestructuras de salud*

```{r}
hospitales <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/hospitales.geojson")
```

```{r}
csac <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/csac.geojson")
```

```{r}
cmb <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/cmb.geojson")
```

```{r}
ess <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/estacionsaludable.geojson")
```

*Por último, sumamos el dataset de alojamientos*

```{r}
hoteles <- read_sf("https://raw.githubusercontent.com/SSoubie/MEU-Hackers/main/Datasets/alojamientos.geojson")
```

```{r}
ggplot() +
  geom_sf(data = filter(calles, tipo_c=="AVENIDA"))+
  geom_sf(data = metrobus, color="yellow")+
  geom_sf(data=csac, color="red")+
  geom_sf(data=cmb, color="red")+
  geom_sf(data=ess, color="red")
```

*creamos un dataset con todas las infraestructuras de salud públicas de la Ciudad*

```{r}
hospitales <- mutate(hospitales, tipo="hospital")
csac <- mutate(csac, tipo="csac")
cmb <- mutate(cmb, tipo="barrial")
ess <- mutate(ess, tipo="estacion")
```

*Pusimos un sistema de corrdenadas en dos planos*

```{r}
hospitales <- st_transform(hospitales, crs="+proj=tmerc +lat_0=-34.6297166 +lon_0=-58.4627 +k=1 +x_0=100000 +y_0=100000 +ellps=intl +units=m +no_defs")
csac <- st_transform(csac, crs=st_crs(hospitales))
metrobus <- st_transform(metrobus, crs = st_crs(hospitales))
subte <- st_transform(subte, crs = st_crs(hospitales))
hoteles <- st_transform(hoteles, crs=st_crs(hospitales))
mapaCABA <- st_transform(mapaCABA, crs = st_crs(hospitales))
manzanas <- st_transform(manzanas, crs = st_crs(hospitales))
```

*Elegimos la cobertura que creemos conveniente para una atección de urgencia de un hospital*

```{r}
coberturaHospitales <- hospitales %>% 
    st_buffer(dist = 1000) %>%
    summarise(cobertura=TRUE)
```

```{r}
coberturacsac <- csac %>% 
    st_buffer(dist = 500) %>%
    summarise(cobertura=TRUE)
```

```{r}
coberturmetrobus <- metrobus %>% 
    st_buffer(dist = 500) %>%
    summarise(cobertura=TRUE)
```

```{r}
coberturasubte <- subte %>% 
    st_buffer(dist = 500) %>%
    summarise(cobertura=TRUE)
```

*Agregar degrades*

```{r}
ggplot()+
  geom_sf(data=mapaCABA, fill="NA")+
  geom_sf(data=coberturaHospitales, fill="red")+
  geom_sf(data=coberturacsac, fill="green")+
  geom_sf(data=coberturasubte, fill="yellow")+
  geom_sf(data=coberturmetrobus, fill="orange")+
  geom_sf(data=hoteles, fill="black")+
  theme_void()
```

*Calculamos la densidad de población*

```{r}
radiosCensales <- radiosCensales %>% 
  mutate(AREA_KM2=round(AREA_KM2, 2), 
        densidadPob=round(POBLACION/AREA_KM2, 2)) %>% 
  st_transform(radiosCensales,crs=st_crs(hospitales))
```

```{r}
ggplot() +
  geom_sf(data = radiosCensales, aes(fill=densidadPob))+
  scale_fill_viridis_c()+
  theme_void()
```

*Hacemos un dataset solo con las avenidas*

```{r}
avenidas <- filter(calles, tipo_c=="AVENIDA")
```

*Centroides de manzanas*

```{r}
manzanacentroide <- st_centroid(manzanas)
```
```{r}
ggplot()+ geom_sf(data = manzanas, fill="NA") +
  geom_sf(data = manzanacentroide, color="blue", size=0.001)+
  theme_void()
```

```{r}
avenidas <- st_transform(avenida, crs = st_crs(hospitales))
```

*Calculamos la distancias de los centroides de manzana a los distintos puntos de transporte*

```{r}
distanciavenida <- st_distance(manzanacentroide, avenidas)

distanciasubte <- st_distance(manzanacentroide, subte)

distanciametrobus <- st_distance(manzanacentroide, metrobus)
```

*Nos quedamos con la distancia miníma de cada manzana con una avenida*

```{r}
avenidacercana <- apply(distanciavenida,1,function(x) min(x))
```

*Hacemos lo mismo para las estaciones de subte y las paradas del metrobus*

```{r}
subtecercano <- apply(distanciasubte,1, function(x) min(x))
metrobuscercano <- apply(distanciametrobus,1, function(x) min(x))
```

*Redondeamos los valores*

```{r}
avenidacercana <- round(avenidacercana, 0)
subtecercano <- round(subtecercano, 0)
metrobuscercano <- round(metrobuscercano, 0)
```

*Agregamos las distancias al dataset de manzanas*

```{r}
manzanas <- mutate(manzanas, distanciaavenida=avenidacercana,
                   distanciasubte=subtecercano,
                   distanciametrobus=metrobuscercano)
```
